/* Modern Editor 0.1.0 */
var Editor=function(a,b){this.element=u(a).first(),this.options=this.defaults(b,{delay:200,active:!0,blocks:[]}),this.menu(this.options.menu),this.selection(),this.shortcuts(),this.clean(),this["default"]();var c=this;window.setInterval(this.trigger.bind(this,"refresh"),this.options.delay),this.element.addEventListener("blur",function(a){c.trigger("refresh",a)}),document.addEventListener("keydown",function(a){c.trigger("key",a)}),document.addEventListener("mousedown",function(a){c.trigger("click",a)}),document.addEventListener("touchstart",function(a){c.trigger("click",a)}),document.addEventListener("click",function(a){c.trigger("click",a)}),this.trigger("init")};Editor.prototype.defaults=function(a,b,c){return a="object"==typeof a?a:{},Object.keys(b).forEach(function(c){"undefined"==typeof a[c]&&(a[c]=b[c])}),a},Editor.prototype.command=function(a,b){document.execCommand(a,!1,b),this.trigger("refresh")},u.prototype.editor=function(a){return new Editor(this.first(),a)},u("body").on("drop",function(a){var b=new FormData;b.append("image",a.dataTransfer.files[0]);var c=new XMLHttpRequest;c.open("POST","/upload",!0),c.upload.onprogress=function(a){if(a.lengthComputable){var b=a.loaded/a.total*100;console.log(b+"% uploaded")}},c.onload=function(){200==this.status&&console.log("Success")},c.send(b)}),function(a,b,c){function d(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)}function e(a){if("keypress"==a.type){var b=String.fromCharCode(a.which);return a.shiftKey||(b=b.toLowerCase()),b}return l[a.which]?l[a.which]:m[a.which]?m[a.which]:String.fromCharCode(a.which).toLowerCase()}function f(a){var b=[];return a.shiftKey&&b.push("shift"),a.altKey&&b.push("alt"),a.ctrlKey&&b.push("ctrl"),a.metaKey&&b.push("meta"),b}function g(a){return"shift"==a||"ctrl"==a||"alt"==a||"meta"==a}function h(a,b){var c,d,e,f=[];for(c=a,"+"===c?c=["+"]:(c=c.replace(/\+{2}/g,"+plus"),c=c.split("+")),e=0;e<c.length;++e)d=c[e],o[d]&&(d=o[d]),b&&"keypress"!=b&&n[d]&&(d=n[d],f.push("shift")),g(d)&&f.push(d);if(c=d,e=b,!e){if(!k){k={};for(var h in l)h>95&&112>h||l.hasOwnProperty(h)&&(k[l[h]]=h)}e=k[c]?"keydown":"keypress"}return"keypress"==e&&f.length&&(e="keydown"),{key:d,modifiers:f,action:e}}function i(a,c){return null===a||a===b?!1:a===c?!0:i(a.parentNode,c)}function j(a){function c(a){a=a||{};var b,c=!1;for(b in q)a[b]?c=!0:q[b]=0;c||(t=!1)}function i(a,b,c,d,e,f){var h,i,j=[],k=c.type;if(!o._callbacks[a])return[];for("keyup"==k&&g(a)&&(b=[a]),h=0;h<o._callbacks[a].length;++h)if(i=o._callbacks[a][h],(d||!i.seq||q[i.seq]==i.level)&&k==i.action){var l;(l="keypress"==k&&!c.metaKey&&!c.ctrlKey)||(l=i.modifiers,l=b.sort().join(",")===l.sort().join(",")),l&&(l=d&&i.seq==d&&i.level==f,(!d&&i.combo==e||l)&&o._callbacks[a].splice(h,1),j.push(i))}return j}function k(a,b,c,d){o.stopCallback(b,b.target||b.srcElement,c,d)||!1!==a(b,c)||(b.preventDefault?b.preventDefault():b.returnValue=!1,b.stopPropagation?b.stopPropagation():b.cancelBubble=!0)}function l(a){"number"!=typeof a.which&&(a.which=a.keyCode);var b=e(a);b&&("keyup"==a.type&&r===b?r=!1:o.handleKey(b,f(a),a))}function m(a,b,d,f){function g(b){return function(){t=b,++q[a],clearTimeout(p),p=setTimeout(c,1e3)}}function i(b){k(d,b,a),"keyup"!==f&&(r=e(b)),setTimeout(c,10)}for(var j=q[a]=0;j<b.length;++j){var l=j+1===b.length?i:g(f||h(b[j+1]).action);n(b[j],l,f,a,j)}}function n(a,b,c,d,e){o._directMap[a+":"+c]=b,a=a.replace(/\s+/g," ");var f=a.split(" ");1<f.length?m(a,f,b,c):(c=h(a,c),o._callbacks[c.key]=o._callbacks[c.key]||[],i(c.key,c.modifiers,{type:c.action},d,a,e),o._callbacks[c.key][d?"unshift":"push"]({callback:b,modifiers:c.modifiers,action:c.action,seq:d,level:e,combo:a}))}var o=this;if(a=a||b,!(o instanceof j))return new j(a);o.target=a,o._callbacks={},o._directMap={};var p,q={},r=!1,s=!1,t=!1;o._handleKey=function(a,b,d){var e,f=i(a,b,d);b={};var h=0,j=!1;for(e=0;e<f.length;++e)f[e].seq&&(h=Math.max(h,f[e].level));for(e=0;e<f.length;++e)f[e].seq?f[e].level==h&&(j=!0,b[f[e].seq]=1,k(f[e].callback,d,f[e].combo,f[e].seq)):j||k(f[e].callback,d,f[e].combo);f="keypress"==d.type&&s,d.type!=t||g(a)||f||c(b),s=j&&"keydown"==d.type},o._bindMultiple=function(a,b,c){for(var d=0;d<a.length;++d)n(a[d],b,c)},d(a,"keypress",l),d(a,"keydown",l),d(a,"keyup",l)}var k,l={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},m={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},n={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},o={option:"alt",command:"meta","return":"enter",escape:"esc",plus:"+",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"};for(c=1;20>c;++c)l[111+c]="f"+c;for(c=0;9>=c;++c)l[c+96]=c;j.prototype.bind=function(a,b,c){return a=a instanceof Array?a:[a],this._bindMultiple.call(this,a,b,c),this},j.prototype.unbind=function(a,b){return this.bind.call(this,a,function(){},b)},j.prototype.trigger=function(a,b){return this._directMap[a+":"+b]&&this._directMap[a+":"+b]({},a),this},j.prototype.reset=function(){return this._callbacks={},this._directMap={},this},j.prototype.stopCallback=function(a,b){return-1<(" "+b.className+" ").indexOf(" mousetrap ")||i(b,this.target)?!1:"INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName||b.isContentEditable},j.prototype.handleKey=function(){return this._handleKey.apply(this,arguments)},j.init=function(){var a,c=j(b);for(a in c)"_"!==a.charAt(0)&&(j[a]=function(a){return function(){return c[a].apply(c,arguments)}}(a))},j.init(),a.Mousetrap=j,"undefined"!=typeof module&&module.exports&&(module.exports=j),"function"==typeof define&&define.amd&&define(function(){return j})}(window,document),Editor.prototype.add=function(a,b){var c=function(){};b=this.defaults(b,{init:c,action:c,destroy:c}),b.init.call(editor),this.on("action:"+a,b.action.bind(this,this)),this.on("destroy",b.destroy.bind(this,this)),this.trigger("shortcut:add",{shortcut:b.shortcut,action:a}),b.menu&&(b.menu=this.defaults(b.menu,{html:b.menu,title:(b.shortcut?"["+b.shortcut+"] ":"")+a,action:a}),this.trigger("menu:add",b.menu))},Editor.prototype.clean=function(){var a=this;this.clean.editor=this,this.clean.blocks=[],this.on("refresh",function(){this.trigger("clean")}),this.on("clean",function(){u(this.element).children().singles(function(b){a.trigger("editor:clean:single",b)}),u(this.element).children().empty(function(b){a.trigger("clean:empty",b)})}),this.on("clean:post",function(){var a=u(editor.element);this.options.blocks&&a.children().filter(this.clean.filter).each(this.clean.wrap),a.children().nodes.length||""===a.html()||a.html("<p>"+a.html()+"</p>")})},Editor.prototype.clean.filter=function(a){return-1===this.editor.options.blocks.indexOf(a.nodeName.toLowerCase())},Editor.prototype.clean.wrap=function(a){var b=document.createElement("p");b.innerHTML=a.outerHTML,a.parentNode.replaceChild(b,a)},u.prototype.singles=function(a){return this.filter(function(a){return 1==u(a).content().nodes.length}).each(a)},u.prototype.empty=function(a){return this.filter(function(a){return!a.textContent.replace(/\s/,"").length}).each(a)},u.prototype.replace=function(a){this.each(function(b){var c=document.createElement(a);c.innerHTML=b.innerHTML,b.parentNode.replaceChild(c,b)})},u.prototype.wrap=function(a){this.each(function(b){var c=document.createElement(a);c.innerHTML=b.outerHTML,b.parentNode.replaceChild(c,b)})},u.prototype.content=function(){var a=this;return this.join(function(b){return a.slice(b.childNodes)})},Editor.prototype["default"]=function(){this.on("action:default:italic",function(){this.command("italic")}),this.on("action:default:bold",function(){this.command("bold")}),this.on("action:default:link",function(){var a=u(this.selection.element).attr("href"),b=prompt("Link address",a||"");this.command(b?"createLink":"unlink",b)}),this.on("action:default:code",function(){this.tag("code")}),this.on("action:default:info",function(){window.open("https://github.com/franciscop/modern-editor","_blank")})},Editor.prototype.on=function(a,b){this.element&&u(this.element).on("editor:"+a,b.bind(this))},Editor.prototype.trigger=function(a,b){this.element&&(u(this.element).trigger("editor:"+a+":pre",b),u(this.element).trigger("editor:"+a,b),u(this.element).trigger("editor:"+a+":post",b))},Editor.prototype.menu=function(a){this.menu.editor=this,this.menu.visible=!1,a=a||"menu",u("body").append('<ul class="'+a+'"></ul>'),this.menu.element=u("."+a).first(),this.menu.events()},Editor.prototype.menu.add=function(a){var b=this.editor,c=u("<li>").attr({"class":"action",title:a.title,"data-action":a.action}).on("click",function(c){c.preventDefault(),b.trigger("action"),b.trigger("action:"+a.action)}).html(a.html||"");u(this.element).append(c)},Editor.prototype.menu.separator=function(){u(this.element).append('<li class="separator">')},Editor.prototype.menu.show=function(){this.editor.options.active&&(this.element.style.display="block",this.element.visible=!0,this.element.classList.add("visible"))},Editor.prototype.menu.hide=function(){this.element.style.display="none",this.element.visible=!1,this.element.classList.remove("visible")},Editor.prototype.menu.move=function(){var a=this.editor.selection.position,b=u("html").first().getBoundingClientRect(),c=this.element.getBoundingClientRect(),d=a.top-b.top;0>d&&(d=0);var e=a.left+a.width/2-c.width/2;0>e&&(e=0),this.position={top:d+"px",left:e+"px"},this.element.style.left=this.position.left,this.element.style.top=this.position.top},Editor.prototype.menu.events=function(){var a=this.editor,b=this;a.on("menu:add",function(a,c){b.add(c)}),a.on("menu:separator",function(){b.separator()}),a.on("menu:show",function(){b.show()}),a.on("menu:hide",function(){b.hide()}),a.on("menu:move",function(){b.move()}),a.on("click",function(a,c){b.element&&b.element.contains(c.target)&&c.preventDefault()})},Editor.prototype.selection=function(){this.selection.element=!1,this.selection.text="",this.on("refresh",function(){var a=this.element.innerHTML;if(!a||a.match(/^\s+$/)||a.match(/^<br\/?>$/)){this.command("insertParagraph");var b=this.element.querySelector("br");b&&b.parentNode&&b.parentNode.removeChild(b)}}),this.on("refresh",function(){var a=this.selection.text;this.trigger("select:check");var b=this.selection.text;a!=b&&this.trigger("select")}),this.on("select",function(){this.selection.position=this.selection.range.getBoundingClientRect()}),this.on("select",function(){var a=this.selection.text,b="block"!==this.menu.element.style.display;a&&b&&this.trigger("menu:show"),a&&this.trigger("menu:move"),a||b||this.trigger("menu:hide")}),this.on("select:check",function(){var a=window.getSelection();this.selection.text=a.toString();var b=a.anchorNode;return this.selection.text&&b?(this.selection.element=1==b.nodeType?b:b.parentElement,void(this.selection.range=a.getRangeAt(0))):!1}),this.on("click",function(a){this.trigger("refresh",a)})},Editor.prototype.shortcuts=function(){var a=this,b=new Mousetrap;b.stopCallback=function(){return!1},this.on("shortcut:add",function(c,d){return d?void b.bind(d.shortcut,function(b){b.preventDefault(),a.trigger("shortcut",d.action)}):!1}),this.on("shortcut",function(b){a.trigger("action:"+b.detail)}),u(this.element).on("key",function(b){a.trigger("refresh")})},Editor.prototype.tag=function(a,b){a=a.toLowerCase();var c=this.selection.element,d=c.tagName.toLowerCase();if(d!==a||b){var e="rggntymsdvshmuiersds";b=b||{},b["class"]=b["class"]?b["class"]+" "+e:e;var f="<"+a;for(var g in b)f+=" "+g+'="'+(b[g]||"")+'"';f+=">"+this.selection.text+"</"+a+">",this.command("insertHtml",f);var h=u("."+e).first();h.classList.remove(e),0===h.classList.length&&h.removeAttribute("class"),range=document.createRange(),range.selectNodeContents(h);var i=window.getSelection();i.removeAllRanges(),i.addRange(range)}else c.textContent===this.selection.text&&(this.selection.element.outerHTML=this.selection.text);this.trigger("refresh")};