/* Modern Editor 0.1.0 */
var Editor=function(a,b){this.element=u(a).first(),this.options=this.defaults(b,{delay:200,active:!0,blocks:[]}),this.menu(this.options.menu),this.selection(),this.shortcuts(),this.clean(),this["default"]();var c=this;window.setInterval(this.trigger.bind(this,"refresh"),this.options.delay),this.element.addEventListener("blur",function(a){c.trigger("refresh",a)}),document.addEventListener("keydown",function(a){c.trigger("key",a)}),document.addEventListener("mousedown",function(a){c.trigger("click",a)}),document.addEventListener("touchstart",function(a){c.trigger("click",a)}),document.addEventListener("click",function(a){c.trigger("click",a)}),this.trigger("init")};Editor.prototype.defaults=function(a,b,c){return a="object"==typeof a?a:{},Object.keys(b).forEach(function(c){"undefined"==typeof a[c]&&(a[c]=b[c])}),a},Editor.prototype.command=function(a,b){document.execCommand(a,!1,b),this.trigger("refresh")},u.prototype.editor=function(a){return new Editor(this.first(),a)},u("body").on("drop",function(a){var b=new FormData;b.append("image",a.dataTransfer.files[0]);var c=new XMLHttpRequest;c.open("POST","/upload",!0),c.upload.onprogress=function(a){if(a.lengthComputable){var b=a.loaded/a.total*100;console.log(b+"% uploaded")}},c.onload=function(){200==this.status&&console.log("Success")},c.send(b)}),Editor.prototype.add=function(a,b){var c=function(){};b=this.defaults(b,{init:c,action:c,destroy:c}),b.init.call(editor),this.on("action:"+a,b.action.bind(this,this)),this.on("destroy",b.destroy.bind(this,this)),this.trigger("shortcut:add",{shortcut:b.shortcut,action:a}),b.menu&&(b.menu=this.defaults(b.menu,{html:b.menu,title:(b.shortcut?"["+b.shortcut+"] ":"")+a,action:a}),this.trigger("menu:add",b.menu))},Editor.prototype.clean=function(){this.clean.editor=this,this.clean.blocks=[],this.on("refresh",function(){this.trigger("clean")}),this.on("clean",function(){u(this.element).children().singles(function(a){editor.trigger("clean:single",a)}),u(this.element).children().empty(function(a){editor.trigger("clean:empty",a)})}),this.on("clean:after",function(){var a=u(editor.element);this.options.blocks&&a.children().filter(this.clean.filter).each(this.clean.wrap),a.children().nodes.length||""===a.html()||a.html("<p>"+a.html()+"</p>")})},Editor.prototype.clean.filter=function(a){return-1===this.editor.options.blocks.indexOf(a.nodeName.toLowerCase())},Editor.prototype.clean.wrap=function(a){var b=document.createElement("p");b.innerHTML=a.outerHTML,a.parentNode.replaceChild(b,a)},u.prototype.singles=function(a){return this.filter(function(a){return 1==u(a).content().nodes.length}).each(a)},u.prototype.empty=function(a){return this.filter(function(a){return!a.textContent.replace(/\s/,"").length}).each(a)},u.prototype.replace=function(a){this.each(function(b){var c=document.createElement(a);c.innerHTML=b.innerHTML,b.parentNode.replaceChild(c,b)})},u.prototype.wrap=function(a){this.each(function(b){var c=document.createElement(a);c.innerHTML=b.outerHTML,b.parentNode.replaceChild(c,b)})},u.prototype.content=function(){var a=this;return this.join(function(b){return a.slice(b.childNodes)})},Editor.prototype["default"]=function(){this.on("action:default:italic",function(){this.command("italic")}),this.on("action:default:bold",function(){this.command("bold")}),this.on("action:default:link",function(){var a=u(this.selection.element).attr("href"),b=prompt("Link address",a||"");this.command(b?"createLink":"unlink",b)}),this.on("action:default:code",function(){this.tag("code")}),this.on("action:default:info",function(){window.open("https://github.com/franciscop/modern-editor","_blank")})},Editor.prototype.events={},Editor.prototype.on=function(a,b){this.events[a]||(this.events[a]=[]),this.events[a].push(b)},Editor.prototype.trigger=function(a,b){this.events[a]?(this.trigger(a+":before",b),this.events[a].forEach(function(c){this.trigger(a+":pre",b),c.call(this,b),this.trigger(a+":post",b)},this),this.trigger(a+":after",b)):this.events[a+":none"]&&this.trigger(a+":none",b)},Editor.prototype.menu=function(a){this.menu.editor=this,this.menu.visible=!1,a=a||"menu",u("body").append('<ul class="'+a+'"></ul>'),this.menu.element=u("."+a).first(),this.menu.events()},Editor.prototype.menu.add=function(a){var b=this.editor,c=u(document.createElement("li")).attr({title:a.title,"data-action":a.action}).addClass("action").on("click",function(c){c.preventDefault(),b.trigger("action"),b.trigger("action:"+a.action)}).html(a.html).first();this.element.appendChild(c)},Editor.prototype.menu.separator=function(){u(this.element).append('<li class="separator">')},Editor.prototype.menu.show=function(){this.editor.options.active&&(this.element.style.display="block",this.element.visible=!0,this.element.classList.add("visible"))},Editor.prototype.menu.hide=function(){this.element.style.display="none",this.element.visible=!1,this.element.classList.remove("visible")},Editor.prototype.menu.move=function(){var a=this.editor.selection.position,b=u("html").first().getBoundingClientRect(),c=this.element.getBoundingClientRect(),d=a.top-b.top;0>d&&(d=0);var e=a.left+a.width/2-c.width/2;0>e&&(e=0),this.position={top:d+"px",left:e+"px"},this.element.style.left=this.position.left,this.element.style.top=this.position.top},Editor.prototype.menu.events=function(){var a=this.editor,b=this;a.on("menu:add",function(a){b.add(a)}),a.on("menu:separator",function(){b.separator()}),a.on("menu:show",function(){b.show()}),a.on("menu:hide",function(){b.hide()}),a.on("menu:move",function(){b.move()}),a.on("click",function(a){b.element&&b.element.contains(a.target)&&a.preventDefault()})},Editor.prototype.selection=function(){this.selection.element=!1,this.selection.text="",this.on("refresh",function(){var a=this.element.innerHTML;if(!a||a.match(/^\s+$/)||a.match(/^<br\/?>$/)){this.command("insertParagraph");var b=this.element.querySelector("br");b&&b.parentNode&&b.parentNode.removeChild(b)}}),this.on("refresh",function(){var a=this.selection.text;this.trigger("select:check");var b=this.selection.text;a!=b&&this.trigger("select")}),this.on("select",function(){this.selection.position=this.selection.range.getBoundingClientRect()}),this.on("select",function(){var a=this.selection.text,b="block"!==this.menu.element.style.display;a&&b&&this.trigger("menu:show"),a&&this.trigger("menu:move"),a||b||this.trigger("menu:hide")}),this.on("select:check",function(){var a=window.getSelection();this.selection.text=a.toString();var b=a.anchorNode;return this.selection.text&&b?(this.selection.element=1==b.nodeType?b:b.parentElement,void(this.selection.range=a.getRangeAt(0))):!1}),this.on("click",function(a){this.trigger("refresh",a)})},Editor.prototype.shortcuts=function(){var a=this;this.shortcuts.list=[],this.on("shortcut:add",function(b){return b.shortcut?(b.keys=b.shortcut.split("+"),void a.shortcuts.list.push(b)):!1}),this.on("key",function(b){function c(a){return!a.keys.filter(function(a){return!b[a]}).length}b[b.key.toLowerCase()]=!0,b.ctrl=b.ctrlKey||b.metaKey,b.shift=b.shiftKey,b.alt=b.altKey,b.esc=27==b.keyCode;var d=a.shortcuts.list.filter(c);d.forEach(function(a){d["default"]||b.preventDefault(),this.trigger("shortcut",a)},this)}),this.on("shortcut",function(a){this.trigger("action"),this.trigger("action:"+a.action)}),this.on("key",function(a){this.trigger("refresh",a)})},Editor.prototype.tag=function(a,b){a=a.toLowerCase();var c=this.selection.element,d=c.tagName.toLowerCase();if(d!==a||b){var e="rggntymsdvshmuiersds";b=b||{},b["class"]=b["class"]?b["class"]+" "+e:e;var f="<"+a;for(var g in b)f+=" "+g+'="'+(b[g]||"")+'"';f+=">"+this.selection.text+"</"+a+">",this.command("insertHtml",f);var h=u("."+e).first();h.classList.remove(e),0===h.classList.length&&h.removeAttribute("class"),range=document.createRange(),range.selectNodeContents(h);var i=window.getSelection();i.removeAllRanges(),i.addRange(range)}else c.textContent===this.selection.text&&(this.selection.element.outerHTML=this.selection.text);this.trigger("refresh")};