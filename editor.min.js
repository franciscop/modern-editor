var Editor=function(e,t){function n(e,t,n){return e="object"==typeof e?e:{},Object.keys(t).forEach(function(n){"undefined"==typeof e[n]&&(e[n]=t[n])}),e}var i=this;return this.element=this.s(e),this.element?(this.options=n(t,{menu:"menu",delay:200}),this.events={},this.on=function(e,t){i.events[e]||(i.events[e]=[]),i.events[e].push(t)},this.trigger=function(e,t){i.events[e]?(i.trigger(e+":before",t),i.events[e].forEach(function(n){i.trigger(e+":pre",t),n.call(i,t),i.trigger(e+":post",t)}),i.trigger(e+":after",t)):i.events[e+":none"]&&i.trigger(e+":none",t)},this.add=function(e,t){var s=function(){};t=n(t,{init:s,action:s,destroy:s}),t.init.call(i),i.on("action:"+e,t.action.bind(i,i)),i.on("destroy",t.destroy.bind(i)),i.trigger("shortcut:add",{shortcut:t.shortcut,action:e}),t.menu&&(t.menu=n(t.menu,{html:t.menu,title:(t.shortcut?"["+t.shortcut+"] ":"")+e,action:e}),i.trigger("menu:add",t.menu))},this.menu={list:[],element:!1,visible:!1,"class":this.options.menu},this.on("init",function(){var e='<ul class="'+i.menu["class"]+'"></ul>';i.s("body").insertAdjacentHTML("beforeend",e),this.menu.element=i.s("."+i.menu["class"])}),this.on("menu:add",function(e){var t=document.createElement("li");t.classList.add("action"),t.setAttribute("data-action",e.action),t.setAttribute("title",e.title),t.addEventListener("click",function(t){t.preventDefault(),i.trigger("action"),i.trigger("action:"+e.action)}),t.innerHTML=e.html,this.menu.element.appendChild(t)}),this.on("menu:separator",function(){var e=document.createElement("li");e.classList.add("separator"),this.menu.element.appendChild(e)}),this.on("menu:show",function(){this.menu.element.style.display="block",this.menu.element.visible=!0,this.menu.element.classList.add("visible")}),this.on("menu:hide",function(){this.menu.element.style.display="none",this.menu.element.visible=!1,this.menu.element.classList.remove("visible")}),this.on("menu:move",function(){var e=this.selection.position,t=i.s("html").getBoundingClientRect(),n=i.menu.element.getBoundingClientRect(),s=e.top-t.top;0>s&&(s=0);var o=e.left+e.width/2-n.width/2;0>o&&(o=0),i.menu.position={top:s+"px",left:o+"px"},this.menu.element.style.left=this.menu.position.left,this.menu.element.style.top=this.menu.position.top}),this.on("click",function(e){this.menu.element&&this.menu.element.contains(e.target)&&e.preventDefault()}),this.on("click",function(e){this.trigger("refresh",e)}),this.selection={element:!1,text:""},this.on("refresh",function(){var e=i.element.innerHTML;if(!e||e.match(/^\s+$/)||e.match(/^<br\/?>$/)){i.command("insertParagraph");var t=i.element.querySelector("br");t&&t.parentNode&&t.parentNode.removeChild(t)}}),this.on("refresh",function(){var e=this.selection.text;this.trigger("select:check");var t=this.selection.text;e!=t&&this.trigger("select")}),this.on("select",function(){this.selection.position=i.selection.range.getBoundingClientRect()}),this.on("select",function(){var e=this.selection.text,t="block"!==this.menu.element.style.display;e&&t&&this.trigger("menu:show"),e&&this.trigger("menu:move"),e||t||this.trigger("menu:hide")}),this.on("select:check",function(){var e=window.getSelection();this.selection.text=e.toString();var t=e.anchorNode;return this.selection.text&&t?(this.selection.element=1==t.nodeType?t:t.parentElement,void(this.selection.range=e.getRangeAt(0))):!1}),this.shortcuts=[],this.on("shortcut:add",function(e){return e.shortcut?(e.keys=e.shortcut.split("+"),void this.shortcuts.push(e)):!1}),this.on("key",function(e){function t(t){return!t.keys.filter(function(t){return!e[t]}).length}e[e.key.toLowerCase()]=!0,e.ctrl=e.ctrlKey||e.metaKey,e.shift=e.shiftKey,e.alt=e.altKey,e.esc=27==e.keyCode;var n=i.shortcuts.filter(t);n.forEach(function(t){n["default"]||e.preventDefault(),i.trigger("shortcut",t)})}),this.on("shortcut",function(e){i.trigger("action"),i.trigger("action:"+e.action)}),this.on("key",function(e){this.trigger("refresh",e)}),window.setInterval(i.trigger.bind(this,"refresh"),this.options.delay),this.element.addEventListener("blur",function(e){i.trigger("refresh",e)}),document.addEventListener("keydown",function(e){i.trigger("key",e)}),document.addEventListener("mousedown",function(e){i.trigger("click",e)}),document.addEventListener("touchstart",function(e){i.trigger("click",e)}),document.addEventListener("click",function(e){i.trigger("click",e)}),void this.trigger("init")):!1};Editor.prototype.s=function(e,t){return t=t||document,e.nodeType?e:t.querySelector(e)},Editor.prototype.command=function(e,t){document.execCommand(e,!1,t),this.trigger("refresh")},Editor.prototype.tag=function(e,t){e=e.toLowerCase();var n=this.selection.element,i=n.tagName.toLowerCase();if(i!==e||t){var s="rggntymsdvshmuiersds";t=t||{},t["class"]=t["class"]?t["class"]+" "+s:s;var o="<"+e;for(var r in t)o+=" "+r+'="'+(t[r]||"")+'"';o+=">"+this.selection.text+"</"+e+">",editor.command("insertHtml",o);var c=this.s("."+s);c.classList.remove(s),0===c.classList.length&&c.removeAttribute("class"),range=document.createRange(),range.selectNodeContents(c);var l=window.getSelection();l.removeAllRanges(),l.addRange(range)}else n.textContent===this.selection.text&&(this.selection.element.outerHTML=this.selection.text);this.trigger("refresh")};