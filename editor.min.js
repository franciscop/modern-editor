var Editor=function(t,e){function n(t,e,n){return t="object"==typeof t?t:{},Object.keys(e).forEach(function(n){"undefined"==typeof t[n]&&(t[n]=e[n])}),t}var i=this;return this.element=this.s(t),this.element?(this.options=n(e,{menu:"menu",delay:200}),this.events={},this.on=function(t,e){i.events[t]||(i.events[t]=[]),i.events[t].push(e)},this.trigger=function(t,e){i.events[t]?(i.trigger(t+":before",e),i.events[t].forEach(function(n){i.trigger(t+":pre",e),n.call(i,e),i.trigger(t+":post",e)}),i.trigger(t+":after",e)):i.events[t+":none"]&&i.trigger(t+":none",e)},this.add=function(t,e){var o=function(){};e=n(e,{init:o,action:o,destroy:o}),e.init.call(i),i.on("action:"+t,e.action.bind(i)),i.on("destroy",e.destroy.bind(i)),i.trigger("shortcut:add",{shortcut:e.shortcut,action:t}),e.menu&&(e.menu=n(e.menu,{html:e.menu,title:(e.shortcut?"["+e.shortcut+"] ":"")+t,action:t}),i.trigger("menu:add",e.menu))},this.menu={list:[],element:!1,visible:!1,"class":this.options.menu},this.on("init",function(){var t='<ul class="'+i.menu["class"]+'"></ul>';i.s("body").insertAdjacentHTML("beforeend",t),this.menu.element=i.s("."+i.menu["class"])}),this.on("menu:add",function(t){var e=document.createElement("li");e.classList.add("action"),e.setAttribute("data-action",t.action),e.setAttribute("title",t.title),e.addEventListener("click",function(e){e.preventDefault(),i.trigger("action"),i.trigger("action:"+t.action)}),e.innerHTML=t.html,this.menu.element.appendChild(e)}),this.on("menu:separator",function(){var t=document.createElement("li");t.classList.add("separator"),this.menu.element.appendChild(t)}),this.on("menu:show",function(){this.menu.element.style.display="block",this.menu.element.visible=!0}),this.on("menu:hide",function(){this.menu.element.style.display="none",this.menu.element.visible=!1}),this.on("menu:move",function(){var t=this.selection.position,e=i.s("html").getBoundingClientRect(),n=i.menu.element.getBoundingClientRect(),o=10,s=t.top-n.height-o-e.top;0>s&&(s=0);var r=t.left+t.width/2-n.width/2;0>r&&(r=0),i.menu.position={top:s+"px",left:r+"px"},this.menu.element.style.left=this.menu.position.left,this.menu.element.style.top=this.menu.position.top}),this.on("click",function(t){this.menu.element&&this.menu.element.contains(t.target)&&t.preventDefault()}),this.on("click",function(t){this.trigger("refresh",t)}),this.selection={element:!1,text:""},this.on("refresh",function(){var t=i.element.innerHTML;if(!t||t.match(/^\s+$/)||t.match(/^<br\/?>$/)){i.command("insertParagraph");var e=i.element.querySelector("br");e&&e.parentNode&&e.parentNode.removeChild(e)}}),this.on("refresh",function(){var t=this.selection.text;this.trigger("select:check");var e=this.selection.text;t!=e&&this.trigger("select")}),this.on("select",function(){this.selection.position=i.selection.range.getBoundingClientRect()}),this.on("select",function(){var t=this.selection.text,e="block"!==this.menu.element.style.display;t&&e&&this.trigger("menu:show"),t&&this.trigger("menu:move"),t||e||this.trigger("menu:hide")}),this.on("select:check",function(){var t=window.getSelection();this.selection.text=t.toString();var e=t.anchorNode;return this.selection.text&&e?(this.selection.element=1==e.nodeType?e:e.parentElement,void(this.selection.range=t.getRangeAt(0))):!1}),this.shortcuts=[],this.on("shortcut:add",function(t){return t.shortcut?(t.keys=t.shortcut.split("+"),void this.shortcuts.push(t)):!1}),this.on("key",function(t){function e(e){return!e.keys.filter(function(e){return!t[e]}).length}t[t.key.toLowerCase()]=!0,t.ctrl=t.ctrlKey||t.metaKey,t.shift=t.shiftKey,t.alt=t.altKey,t.esc=27==t.keyCode;var n=i.shortcuts.filter(e);n.forEach(function(e){n["default"]||t.preventDefault(),i.trigger("shortcut",e)})}),this.on("shortcut",function(t){i.trigger("action:"+t.action)}),this.on("key",function(t){this.trigger("refresh",t)}),window.setInterval(i.trigger.bind(this,"refresh"),this.options.delay),this.element.addEventListener("blur",function(t){i.trigger("refresh",t)}),document.addEventListener("keydown",function(t){i.trigger("key",t)}),document.addEventListener("mousedown",function(t){i.trigger("click",t)}),document.addEventListener("touchstart",function(t){i.trigger("click",t)}),document.addEventListener("click",function(t){i.trigger("click",t)}),void this.trigger("init")):!1};Editor.prototype.s=function(t,e){return e=e||document,t.nodeType?t:e.querySelector(t)},Editor.prototype.command=function(t,e){return document.execCommand(t,!1,e)};