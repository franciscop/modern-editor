/* Modern Editor 0.2.0 */
function ajax(a,b,c,d){c=c||function(){},b=b||{},b.body=b.body||{},b.method=(b.method||"GET").toUpperCase(),b.headers=b.headers||{},b.headers["X-Requested-With"]=b.headers["X-Requested-With"]||"XMLHttpRequest","undefined"!=typeof window.FormData&&b.body instanceof window.FormData||(b.headers["Content-Type"]=b.headers["Content-Type"]||"application/x-www-form-urlencoded"),/json/.test(b.headers["Content-Type"])&&(b.body=JSON.stringify(b.body)),"object"!=typeof b.body||b.body instanceof window.FormData||(b.body=u().param(b.body));var e=new window.XMLHttpRequest;u(e).on("error timeout abort",function(){c(new Error,null,e)}).on("load",function(){var a=/^(4|5)/.test(e.status)?new Error(e.status):null,b=parseJson(e.response)||e.response;return c(a,b,e)}),e.open(b.method,a);for(var f in b.headers)e.setRequestHeader(f,b.headers[f]);return d&&d(e),e.send(b.body),e}function parseJson(a){try{var b=JSON.parse(a);if(b&&"object"==typeof b)return b}catch(a){}return!1}function generate(a,b){var c=a.html,d=u("<li>").addClass("action").attr({title:a.title,"data-action":a.action});switch(a.type){case"none":return d.html(a.html).first();case"button":return d.addClass("simple").html(a.html).on("click",function(c){a.defaults||c.preventDefault(),b.trigger("action"),b.trigger("action:"+a.action)}).first();case"select":var e=u("<select>").append(function(a){return'<option value="'+a+'">'+c[a]+"</option>"},Object.keys(c)).on("change",function(c){b.trigger("action"),b.trigger("action:"+a.action,c)});return d.addClass("select").append(e).first()}if(c===Object(c)){var f=u('<li class="dropdown action">').append().first();return f}return'<a href="test">Hi there</a>'}var u=function(a,b){return this instanceof u?a instanceof u?a:("string"==typeof a&&(a=this.select(a,b)),a&&a.nodeName&&(a=[a]),void(this.nodes=this.slice(a))):new u(a,b)};u.prototype={get length(){return this.nodes.length}},u.prototype.nodes=[],u.prototype.addClass=function(){return this.eacharg(arguments,function(a,b){a.classList.add(b)})},u.prototype.adjacent=function(a,b,c){return"number"==typeof b&&(b=0===b?[]:new Array(b).join().split(",").map(Number.call,Number)),this.each(function(d,e){var f=document.createDocumentFragment();u(b||{}).map(function(b,c){var f="function"==typeof a?a.call(this,b,c,d,e):a;return"string"==typeof f?this.generate(f):u(f)}).each(function(a){this.isInPage(a)?f.appendChild(u(a).clone().first()):f.appendChild(a)}),c.call(this,d,f)})},u.prototype.after=function(a,b){return this.adjacent(a,b,function(a,b){a.parentNode.insertBefore(b,a.nextSibling)})},u.prototype.ajax=function(a,b){return this.handle("submit",function(c){ajax(u(this).attr("action"),{body:u(this).serialize(),method:u(this).attr("method")},a&&a.bind(this),b&&b.bind(this))})},u.prototype.append=function(a,b){return this.adjacent(a,b,function(a,b){a.appendChild(b)})},u.prototype.args=function(a,b,c){return"function"==typeof a&&(a=a(b,c)),"string"!=typeof a&&(a=this.slice(a).map(this.str(b,c))),a.toString().split(/[\s,]+/).filter(function(a){return a.length})},u.prototype.array=function(a){a=a;var b=this;return this.nodes.reduce(function(c,d,e){var f;return a?(f=a.call(b,d,e),f||(f=!1),"string"==typeof f&&(f=u(f)),f instanceof u&&(f=f.nodes)):f=d.innerHTML,c.concat(f!==!1?f:[])},[])},u.prototype.attr=function(a,b,c){if(c=c?"data-":"",void 0!==b){var d=a;a={},a[d]=b}return"object"==typeof a?this.each(function(b){for(var d in a)b.setAttribute(c+d,a[d])}):this.length?this.first().getAttribute(c+a):""},u.prototype.before=function(a,b){return this.adjacent(a,b,function(a,b){a.parentNode.insertBefore(b,a)})},u.prototype.children=function(a){return this.map(function(a){return this.slice(a.children)}).filter(a)},u.prototype.clone=function(){return this.map(function(a,b){var c=a.cloneNode(!0),d=this.getAll(c);return this.getAll(a).each(function(a,b){for(var c in this.mirror)this.mirror[c](a,d.nodes[b])}),c})},u.prototype.getAll=function(a){return u([a].concat(u("*",a).nodes))},u.prototype.mirror={},u.prototype.mirror.events=function(a,b){if(a._e)for(var c in a._e)a._e[c].forEach(function(a){u(b).on(c,a)})},u.prototype.mirror.select=function(a,b){u(a).is("select")&&(b.value=a.value)},u.prototype.mirror.textarea=function(a,b){u(a).is("textarea")&&(b.value=a.value)},u.prototype.closest=function(a){return this.map(function(b){do if(u(b).is(a))return b;while((b=b.parentNode)&&b!==document)})},u.prototype.data=function(a,b){return this.attr(a,b,!0)},u.prototype.each=function(a){return this.nodes.forEach(a.bind(this)),this},u.prototype.eacharg=function(a,b){return this.each(function(c,d){this.args(a,c,d).forEach(function(a){b.call(this,c,a)},this)})},u.prototype.filter=function(a){var b=function(b){return b.matches=b.matches||b.msMatchesSelector||b.webkitMatchesSelector,b.matches(a||"*")};return"function"==typeof a&&(b=a),a instanceof u&&(b=function(b){return a.nodes.indexOf(b)!==-1}),u(this.nodes.filter(b))},u.prototype.find=function(a){return this.map(function(b){return u(a||"*",b)})},u.prototype.first=function(){return this.nodes[0]||!1},u.prototype.generate=function(a){return/^\s*<t(h|r|d)/.test(a)?u(document.createElement("table")).html(a).children().nodes:/^\s*</.test(a)?u(document.createElement("div")).html(a).children().nodes:document.createTextNode(a)},u.prototype.handle=function(){var a=this.slice(arguments).map(function(a){return"function"==typeof a?function(b){b.preventDefault(),a.apply(this,arguments)}:a},this);return this.on.apply(this,a)},u.prototype.hasClass=function(){return this.is("."+this.args(arguments).join("."))},u.prototype.html=function(a){return void 0===a?this.first().innerHTML||"":this.each(function(b){b.innerHTML=a})},u.prototype.is=function(a){return this.filter(a).length>0},u.prototype.isInPage=function(a){return a!==document.body&&document.body.contains(a)},u.prototype.last=function(){return this.nodes[this.length-1]||!1},u.prototype.map=function(a){return a?u(this.array(a)).unique():this},u.prototype.not=function(a){return this.filter(function(b){return!u(b).is(a||!0)})},u.prototype.off=function(a){return this.eacharg(a,function(a,b){u(a._e?a._e[b]:[]).each(function(c){a.removeEventListener(b,c)})})},u.prototype.on=function(a,b,c){if("string"==typeof b){var d=b;b=function(a){var b=arguments;u(a.currentTarget).find(d).each(function(d){if(d===a.target||d.contains(a.target)){try{Object.defineProperty(a,"currentTarget",{get:function(){return d}})}catch(a){}c.apply(d,b)}})}}var e=function(a){return b.apply(this,[a].concat(a.detail||[]))};return this.eacharg(a,function(a,b){a.addEventListener(b,e),a._e=a._e||{},a._e[b]=a._e[b]||[],a._e[b].push(e)})},u.prototype.param=function(a){return Object.keys(a).map(function(b){return this.uri(b)+"="+this.uri(a[b])}.bind(this)).join("&")},u.prototype.parent=function(a){return this.map(function(a){return a.parentNode}).filter(a)},u.prototype.prepend=function(a,b){return this.adjacent(a,b,function(a,b){a.insertBefore(b,a.firstChild)})},u.prototype.remove=function(){return this.each(function(a){a.parentNode.removeChild(a)})},u.prototype.removeClass=function(){return this.eacharg(arguments,function(a,b){a.classList.remove(b)})},u.prototype.replace=function(a,b){var c=[];return this.adjacent(a,b,function(a,b){c=c.concat(this.slice(b.children)),a.parentNode.replaceChild(b,a)}),u(c)},u.prototype.scroll=function(){return this.first().scrollIntoView({behavior:"smooth"}),this},u.prototype.select=function(a,b){if(a=a.replace(/^\s*/,"").replace(/\s*$/,""),b)return this.select.byCss(a,b);for(var c in this.selectors)if(b=c.split("/"),new RegExp(b[1],b[2]).test(a))return this.selectors[c](a);return this.select.byCss(a)},u.prototype.select.byCss=function(a,b){return(b||document).querySelectorAll(a)},u.prototype.selectors={},u.prototype.selectors[/^\.[\w\-]+$/]=function(a){return document.getElementsByClassName(a.substring(1))},u.prototype.selectors[/^\w+$/]=function(a){return document.getElementsByTagName(a)},u.prototype.selectors[/^\#[\w\-]+$/]=function(a){return document.getElementById(a.substring(1))},u.prototype.selectors[/^</]=function(a){return u().generate(a)},u.prototype.serialize=function(){var a=this;return this.slice(this.first().elements).reduce(function(b,c){return!c.name||c.disabled||"file"===c.type?b:/(checkbox|radio)/.test(c.type)&&!c.checked?b:"select-multiple"===c.type?(u(c.options).each(function(d){d.selected&&(b+="&"+a.uri(c.name)+"="+a.uri(d.value))}),b):b+"&"+a.uri(c.name)+"="+a.uri(c.value)},"").slice(1)},u.prototype.siblings=function(a){return this.parent().children(a).not(this)},u.prototype.size=function(){return this.first().getBoundingClientRect()},u.prototype.slice=function(a){return a&&0!==a.length&&"string"!=typeof a&&"[object Function]"!==a.toString()?a.length?[].slice.call(a.nodes||a):[a]:[]},u.prototype.str=function(a,b){return function(c){return"function"==typeof c?c.call(this,a,b):c.toString()}},u.prototype.text=function(a){return void 0===a?this.first().textContent||"":this.each(function(b){b.textContent=a})},u.prototype.toggleClass=function(a,b){return!!b===b?this[b?"addClass":"removeClass"](a):this.eacharg(a,function(a,b){a.classList.toggle(b)})},u.prototype.trigger=function(a){var b=this.slice(arguments).slice(1);return this.eacharg(a,function(a,c){var d,e={bubbles:!0,cancelable:!0,detail:b};try{d=new window.CustomEvent(c,e)}catch(a){d=document.createEvent("CustomEvent"),d.initCustomEvent(c,!0,!0,b)}a.dispatchEvent(d)})},u.prototype.unique=function(){return u(this.nodes.reduce(function(a,b){var c=null!==b&&void 0!==b&&b!==!1;return c&&a.indexOf(b)===-1?a.concat(b):a},[]))},u.prototype.uri=function(a){return encodeURIComponent(a).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},u.prototype.wrap=function(a){function b(a){for(;a.firstElementChild;)a=a.firstElementChild;return u(a)}return this.map(function(c){return u(a).each(function(a){b(a).append(c.cloneNode(!0)),c.parentNode.replaceChild(a,c)})})},"object"==typeof module&&module.exports&&(module.exports={u:u,ajax:ajax}),function(a,b,c){function d(a,b,c){return a.addEventListener?void a.addEventListener(b,c,!1):void a.attachEvent("on"+b,c)}function e(a){if("keypress"==a.type){var b=String.fromCharCode(a.which);return a.shiftKey||(b=b.toLowerCase()),b}return r[a.which]?r[a.which]:s[a.which]?s[a.which]:String.fromCharCode(a.which).toLowerCase()}function f(a,b){return a.sort().join(",")===b.sort().join(",")}function g(a){var b=[];return a.shiftKey&&b.push("shift"),a.altKey&&b.push("alt"),a.ctrlKey&&b.push("ctrl"),a.metaKey&&b.push("meta"),b}function h(a){return a.preventDefault?void a.preventDefault():void(a.returnValue=!1)}function i(a){return a.stopPropagation?void a.stopPropagation():void(a.cancelBubble=!0)}function j(a){return"shift"==a||"ctrl"==a||"alt"==a||"meta"==a}function k(){if(!q){q={};for(var a in r)a>95&&a<112||r.hasOwnProperty(a)&&(q[r[a]]=a)}return q}function l(a,b,c){return c||(c=k()[a]?"keydown":"keypress"),"keypress"==c&&b.length&&(c="keydown"),c}function m(a){return"+"===a?["+"]:(a=a.replace(/\+{2}/g,"+plus"),a.split("+"))}function n(a,b){var c,d,e,f=[];for(c=m(a),e=0;e<c.length;++e)d=c[e],u[d]&&(d=u[d]),b&&"keypress"!=b&&t[d]&&(d=t[d],f.push("shift")),j(d)&&f.push(d);return b=l(d,f,b),{key:d,modifiers:f,action:b}}function o(a,c){return null!==a&&a!==b&&(a===c||o(a.parentNode,c))}function p(a){function c(a){a=a||{};var b,c=!1;for(b in u)a[b]?c=!0:u[b]=0;c||(x=!1)}function k(a,b,c,d,e,g){var h,i,k=[],l=c.type;if(!s._callbacks[a])return[];for("keyup"==l&&j(a)&&(b=[a]),h=0;h<s._callbacks[a].length;++h)if(i=s._callbacks[a][h],(d||!i.seq||u[i.seq]==i.level)&&l==i.action&&("keypress"==l&&!c.metaKey&&!c.ctrlKey||f(b,i.modifiers))){var m=!d&&i.combo==e,n=d&&i.seq==d&&i.level==g;(m||n)&&s._callbacks[a].splice(h,1),k.push(i)}return k}function l(a,b,c,d){s.stopCallback(b,b.target||b.srcElement,c,d)||a(b,c)===!1&&(h(b),i(b))}function m(a){"number"!=typeof a.which&&(a.which=a.keyCode);var b=e(a);if(b)return"keyup"==a.type&&v===b?void(v=!1):void s.handleKey(b,g(a),a)}function o(){clearTimeout(t),t=setTimeout(c,1e3)}function q(a,b,d,f){function g(b){return function(){x=b,++u[a],o()}}function h(b){l(d,b,a),"keyup"!==f&&(v=e(b)),setTimeout(c,10)}u[a]=0;for(var i=0;i<b.length;++i){var j=i+1===b.length,k=j?h:g(f||n(b[i+1]).action);r(b[i],k,f,a,i)}}function r(a,b,c,d,e){s._directMap[a+":"+c]=b,a=a.replace(/\s+/g," ");var f,g=a.split(" ");return g.length>1?void q(a,g,b,c):(f=n(a,c),s._callbacks[f.key]=s._callbacks[f.key]||[],k(f.key,f.modifiers,{type:f.action},d,a,e),void s._callbacks[f.key][d?"unshift":"push"]({callback:b,modifiers:f.modifiers,action:f.action,seq:d,level:e,combo:a}))}var s=this;if(a=a||b,!(s instanceof p))return new p(a);s.target=a,s._callbacks={},s._directMap={};var t,u={},v=!1,w=!1,x=!1;s._handleKey=function(a,b,d){var e,f=k(a,b,d),g={},h=0,i=!1;for(e=0;e<f.length;++e)f[e].seq&&(h=Math.max(h,f[e].level));for(e=0;e<f.length;++e)if(f[e].seq){if(f[e].level!=h)continue;i=!0,g[f[e].seq]=1,l(f[e].callback,d,f[e].combo,f[e].seq)}else i||l(f[e].callback,d,f[e].combo);var m="keypress"==d.type&&w;d.type!=x||j(a)||m||c(g),w=i&&"keydown"==d.type},s._bindMultiple=function(a,b,c){for(var d=0;d<a.length;++d)r(a[d],b,c)},d(a,"keypress",m),d(a,"keydown",m),d(a,"keyup",m)}for(var q,r={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},s={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},t={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},u={option:"alt",command:"meta",return:"enter",escape:"esc",plus:"+",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"},v=1;v<20;++v)r[111+v]="f"+v;for(v=0;v<=9;++v)r[v+96]=v;p.prototype.bind=function(a,b,c){var d=this;return a=a instanceof Array?a:[a],d._bindMultiple.call(d,a,b,c),d},p.prototype.unbind=function(a,b){var c=this;return c.bind.call(c,a,function(){},b)},p.prototype.trigger=function(a,b){var c=this;return c._directMap[a+":"+b]&&c._directMap[a+":"+b]({},a),c},p.prototype.reset=function(){var a=this;return a._callbacks={},a._directMap={},a},p.prototype.stopCallback=function(a,b){var c=this;return!((" "+b.className+" ").indexOf(" mousetrap ")>-1)&&(!o(b,c.target)&&("INPUT"==b.tagName||"SELECT"==b.tagName||"TEXTAREA"==b.tagName||b.isContentEditable))},p.prototype.handleKey=function(){var a=this;return a._handleKey.apply(a,arguments)},p.init=function(){var a=p(b);for(var c in a)"_"!==c.charAt(0)&&(p[c]=function(b){return function(){return a[b].apply(a,arguments)}}(c))},p.init(),a.Mousetrap=p,"undefined"!=typeof module&&module.exports&&(module.exports=p),"function"==typeof define&&define.amd&&define(function(){return p})}(window,document);var Editor=function(a,b){if(!(this instanceof Editor))return new Editor(a,b);this.element=u(a).first(),u(this.element).html().replace(/\s+/,"")&&u(this.element).children().length||u(this.element).html("<p>"),this.model=this.parse(this.element.innerHTML),this.history(this),this.history.register(this.model),b=b||{},b.delay=b.delay||1e3,b.active=void 0===b.active||b.active,b.blocks=b.blocks||[],this.options=b,this.menu(this.options.menu),this.selection(),this.shortcuts(),this.clean(),this.default();var c=this;window.setInterval(this.trigger.bind(this,"refresh"),this.options.delay),this.element.addEventListener("blur",function(a){c.trigger("refresh",a)}),document.addEventListener("keydown",function(a){c.trigger("refresh",a)}),document.addEventListener("mousedown",function(a){c.trigger("refresh",a)}),document.addEventListener("touchstart",function(a){c.trigger("refresh",a)}),document.addEventListener("click",function(a){c.trigger("refresh",a)}),this.trigger("init");var c=this;this.on("refresh",function(){c.history.register()})};Editor.prototype.defaults=function(a,b,c){return a="object"==typeof a?a:{},b=JSON.parse(JSON.stringify(b||{})),Object.keys(b).forEach(function(c){"undefined"==typeof a[c]&&(a[c]=b[c])}),a},Editor.prototype.command=function(a,b){document.execCommand(a,!1,b),this.trigger("refresh")},u.prototype.editor=function(a){return new Editor(this.first(),a)},Editor.prototype.virtual=function(){this.virtual.editor=this},Editor.prototype.history=function(){this.history.editor=this},Editor.prototype.add=function(a,b){var c=this,d=function(){};b.name=a,b.init=b.init||d,b.action=b.action||d,b.destroy=b.destroy||d,b.listen=b.listen||!1;var c=this;if("type"===b.name)var e=function(a){if("change"===a.type)b.action.call(c,c,a.target.value,a);else if("keydown"===a.type){var d=c.menu.elements[b.name];d.selectedIndex++,d.value||(d.selectedIndex=0),b.action.call(c,c,d.value,a)}};else var e=b.action.bind(c,c);b.init.call(this,this),this.on("action:"+a,e.bind(this)),this.on("destroy",b.destroy.bind(this,this)),this.trigger("shortcut:add",{shortcut:b.shortcut,action:a}),b.menu&&this.trigger("menu:add",b.menu,b),b.listen&&this.on(b.listen,e)},Editor.prototype.clean=function(){var a=this;this.clean.editor=this,this.on("refresh",function(){a.trigger("clean")}),this.on("clean",function(){u(this).children().singles(function(b){a.trigger("clean:single",b)}),u(this).children().empty(function(b){a.trigger("clean:empty",b)})}),this.on("clean:after",function(){var b=u(a.element);a.clean.blocks&&b.children().filter(a.clean.filter).each(a.clean.wrap),b.children().nodes.length||""===b.html()||b.html("<p>"+b.html()+"</p>")})},Editor.prototype.clean.blocks=["h1","h2","h3","h4","h5","h6","p","pre","img","ul","ol"],Editor.prototype.clean.filter=function(a){return Editor.prototype.clean.blocks.indexOf(a.nodeName.toLowerCase())===-1},Editor.prototype.clean.wrap=function(a){var b=document.createElement("p");b.innerHTML=a.outerHTML,a.parentNode.replaceChild(b,a)},u.prototype.singles=function(a){return this.filter(function(a){return 1==u(a).content().nodes.length}).each(a)},u.prototype.empty=function(a){return this.filter(function(a){return!a.textContent.replace(/\s/,"").length}).each(a)},u.prototype.replace=function(a){this.each(function(a){a.parentNode.replaceChild(u("<p>").html(u(a).html()).first(),a)})},u.prototype.content=function(){return this.map(function(a){return this.slice(a.childNodes)})},function(a,b){var c=a=>a.replace(/\s*\n\s*/g,"").replace(/^\s+/,"").replace(/\s+$/,""),d=a=>[].slice.call(a.childNodes).reduce((a,b,c,e)=>{if(1!==b.nodeType)return a;if("BR"===b.nodeName)return a;var f=e.slice(0,c).map(a=>a.textContent).join(""),g=d(b);for(var h in g)g[h].forEach(b=>{a[h]=a[h]||[],a[h].push(Object.assign(b,{position:b.position+f.length}))});var i=!1;if(b.attributes.length){i={};for(var c=0;c<b.attributes.length;c++)i[b.attributes[c].nodeName]=b.attributes[c].value}var j=b.nodeName.toLowerCase();return a[j]=a[j]||[],a[j].push({position:f.length,size:b.textContent.length,attributes:i}),a},{a:[],strong:[],em:[]});a.flatten=(a=>Object.keys(a).reduce((b,c)=>{var d=a[c].map(a=>Object.assign(a,{type:c}));return b.concat(d)},[])),a.deduplicate=function(b){var c=[];return a.flatten(b).reduce((a,b,d,e)=>{var f=a.concat(e.map((a,e)=>{if(!c.includes(d)){if(d===e)return b;if(b.position<=a.position&&a.position+a.size<=b.position+b.size){c.push(e),b.tags=b.tags||[];var f=a;return f.position=a.position-b.position,b.tags.push(f),b}return!1}}).filter(a=>a)[0]);return f},[]).filter((a,b)=>!c.includes(b))},a.build=function(){return JSON.parse(JSON.stringify(this.model)).map(b=>Object.assign(b,{tags:a.deduplicate(b.tags)})).map(b.build).join("")},a.parse=function(a){return JSON.parse(JSON.stringify(u("<article>").html(c(a)).children().nodes.map(a=>({type:a.nodeName.toLowerCase(),text:c(a.textContent),tags:d(a)}))))}}(Editor.prototype,Editor.prototype.virtual),Editor.prototype.default=function(){var a=this;this.on("action:default:italic",function(){a.command("italic")}),this.on("action:default:bold",function(){a.command("bold")}),this.on("action:default:link",function(){var b=u(a.selection.element).attr("href"),c=prompt("Link address",b||"");a.command(c?"createLink":"unlink",c)}),this.on("action:default:code",function(){a.tag("code")}),this.on("action:default:info",function(){window.open("https://github.com/franciscop/modern-editor","_blank")}),u(this.element).on("drop",function(a){editor.trigger("drop",editor,a.dataTransfer.files,a)})},Editor.prototype.events={},Editor.prototype.on=function(a,b){u(this.element).on("editor:"+a,function(a){return b.apply(this,a.detail)})},Editor.prototype.trigger=function(a){var b=[].slice.call(arguments,1),c=u(this.element);c.trigger.apply(c,["editor:"+a+":before"].concat(b)),c.trigger.apply(c,["editor:"+a].concat(b)),c.trigger.apply(c,["editor:"+a+":after"].concat(b))},function(a){var b=a=>a.split("").reduce((a,b)=>(a<<5)-a+b.charCodeAt(0),0);a.register=function(a,c){var d=this.editor.history;d.entries=d.entries||[],d.undone=d.undone||[];var e=this.editor.selection.cursor(this.editor),f=this.editor.element.innerHTML,g=b(f),h=d.entries[d.entries.length-1];if(!h||h.hash!==g){var i=this.editor.parse(f);d.entries.push({model:i,type:a||"none",date:c||new Date,hash:g,cursor:e}),this.editor.model=i,d.undone=[]}},a.undo=function(){if(a.entries=a.entries||[],a.undone=a.undone||[],a.entries.length>1){var b=a.entries.pop(),c=a.entries.pop();this.editor.model=c.model,this.editor.element.innerHTML=this.editor.build(this.editor.model),this.editor.selection.setCursor(c.cursor),a.undone.push(b);var b=a.undone;a.register(),a.undone=b}},a.redo=function(){if(a.undone.length){var b=a.undone.pop();a.entries.push(b),this.editor.model=b.model,this.editor.element.innerHTML=this.editor.build(this.editor.model),this.editor.selection.setCursor(b.cursor)}}}(Editor.prototype.history),Editor.prototype.menu=function(a){this.menu.editor=this,this.menu.visible=!1,a=a||"menu",u("body").append('<ul class="'+a+'"></ul>'),this.menu.element=u("."+a).first(),this.menu.events()},Editor.prototype.menu.test=function(a){this.editor.b=a},Editor.prototype.menu.add=function(a,b){a=a.html?a:{html:JSON.parse(JSON.stringify(a)),type:a.type||"string"==typeof a?"button":"select"},a.type=a.type||"none",a.title=(b.shortcut?"["+b.shortcut+"] ":"")+b.name,a.action=a.action||b.name;var c=this.editor;a instanceof Array&&(a=a[0]);var d=generate(a,c);this.element.appendChild(d),this.editor.menu.elements=this.editor.menu.elements||{},this.editor.menu.elements[a.action]=u(this.element).children().children().last()},Editor.prototype.menu.separator=function(){u(this.element).append('<li class="separator">')},Editor.prototype.menu.show=function(){this.editor.options.active&&(this.element.style.display="block",this.element.visible=!0,this.element.classList.add("visible"))},Editor.prototype.menu.hide=function(){this.element.style.display="none",this.element.visible=!1,this.element.classList.remove("visible")},Editor.prototype.menu.move=function(){var a=this.editor.selection.position,b=u("html").first().getBoundingClientRect(),c=this.element.getBoundingClientRect(),d=a.top-b.top;d<0&&(d=0);var e=a.left+a.width/2-c.width/2;e<0&&(e=0),this.position={top:d+"px",left:e+"px"},this.element.style.left=this.position.left,this.element.style.top=this.position.top},Editor.prototype.menu.events=function(){var a=this.editor,b=this;a.on("menu:add",function(a,c){b.add.call(b,a,c)}),a.on("menu:separator",function(){b.separator()}),a.on("menu:show",function(){b.show()}),a.on("menu:hide",function(){b.hide()}),a.on("menu:move",function(){b.move()}),u(b.element).on("mousedown",function(a){0===u(a.target).closest("select").length&&a.preventDefault()}),u("body").on("click",function(a){b.element&&b.element.contains(a.currentTarget)&&(console.log("Prevented shortcut on click"),a.preventDefault())})},Editor.prototype.selection=function(){var a=this;this.selection.editor=this,this.selection.element=!1,this.selection.elements=[],this.selection.text="",this.on("refresh",function(){u(this).children("br").remove(),u(this).html().match(/^\s*$/)&&a.command("insertParagraph")}),this.on("refresh",function(){var b=a.selection.text;a.trigger("select:check");var c=a.selection.text;b!=c&&a.trigger("select")}),this.on("select",function(){a.selection.position=a.selection.range.getBoundingClientRect()}),this.on("select",function(){var b=a.selection.text,c="block"!==a.menu.element.style.display;b&&c&&a.trigger("menu:show"),b&&a.trigger("menu:move"),b||c||a.trigger("menu:hide"),console.log("triggered",b,c)}),this.on("select:check",function(){var b=window.getSelection();a.selection.text=b.toString();var c=b.anchorNode;return!(!a.selection.text||!c)&&(a.selection.element=1==c.nodeType?c:c.parentElement,void(a.selection.range=b.getRangeAt(0)))})},Editor.prototype.selection.save=function(){var a=this.editor,b=window.getSelection();a.selection.saved={};for(var c in b)a.selection.saved[c]=b[c]},Editor.prototype.selection.restore=function(){var a=this.editor;if(a&&a.selection.saved){var b=a.selection.saved;console.log("Saved:",b),range=document.createRange(),range.setStart(b.anchorNode,b.anchorOffset),range.setEnd(b.focusNode,b.focusOffset);var c=window.getSelection();c.removeAllRanges(),c.addRange(range)}},Editor.prototype.selection.cursor=function(a){for(var b=window.getSelection(),c=b.anchorNode;c&&1!==c.nodeType;)c=c.parentNode;return{index:u(a.element).children().nodes.indexOf(c),offset:b.anchorOffset}},Editor.prototype.selection.setCursor=function(a){this.editor.element.focus(),range=document.createRange();var b=u(this.editor.element).children().nodes[a.index];if(b){var c=b.childNodes[0];if(c)try{range.setStart(c,a.offset),range.setEnd(c,a.offset);var d=window.getSelection();d.removeAllRanges(),d.addRange(range)}catch(a){console.log("Error:",a)}}},Editor.prototype.shortcuts=function(){var a=this,b=new Mousetrap;b.stopCallback=function(){return!1},this.on("shortcut:add",function(c){return!(!c||!c.shortcut)&&void b.bind(c.shortcut,function(b){b.preventDefault(),a.trigger("shortcut",c.action,b)})}),this.on("shortcut",function(b,c){a.trigger("action:"+b,c)}),u(this.element).on("keyup",function(b){a.history.register(),a.trigger("refresh")})},Editor.prototype.tag=function(a,b){a=a.toLowerCase();var c=this.selection.element,d=c.tagName.toLowerCase();if(d!==a||b){var e="rggntymsdvshmuiersds";b=b||{},b.class=b.class?b.class+" "+e:e;var f="<"+a;for(var g in b)f+=" "+g+'="'+(b[g]||"")+'"';f+=">"+this.selection.text+"</"+a+">";try{window.getSelection();this.command("insertHtml",f)}catch(a){console.log("Error:",a)}var h=u("."+e).first();if(!h)return;h.classList.remove(e),0===h.classList.length&&h.removeAttribute("class");var i=document.createRange();i.selectNodeContents(h);var j=window.getSelection();j.removeAllRanges(),j.addRange(i)}else c.textContent===this.selection.text&&(this.selection.element.outerHTML=this.selection.text);this.trigger("refresh")},function(a){a.clean=(a=>a.replace(/^\s+/,"").replace(/\s+$/,""));var b={attrs:a=>a?" "+Object.keys(a).map(b=>`${b}="${a[b]}"`).join(" "):"",open:a=>`<${a.type}${b.attrs(a.attributes)}>`,close:a=>`</${a.type}>`},c=(a,b)=>b.position-a.position;a.tag=((b,d=[])=>d.sort(c).reduce((b,c)=>b.slice(0,c.position)+a.build(Object.assign(c,{text:b.slice(c.position,c.position+c.size)}))+b.slice(c.position+c.size),b)),a.build=(c=>b.open(c)+a.tag(c.text||"",c.tags)+b.close(c))}(Editor.prototype.virtual);